<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Notes on the Art of TDD - Uno (Part 2)</title>

  
  
  <meta name="keywords" content="ood series, tdd"/>
  
  
  <meta property="og:title" content="Notes on the Art of TDD - Uno (Part 2)">
  <meta property="og:type" content="note">
  <meta property="og:url" content="https://johnhearn.github.io//articles/notes-on-art-of-tdd-uno-part-2/">
  <meta property="og:image" content="https://johnhearn.github.io/">
  <meta property="og:description" content="Personal site for blogging and about science, software and such">
  <meta property="og:site_name" content="John Hearn">
  
  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@johnhearnbcn">
  <meta name="twitter:creator" content="@johnhearnbcn">
  <meta name="twitter:title"   content="Notes on the Art of TDD - Uno (Part 2)">

  
  <meta name="twitter:description" content="Personal site for blogging and about science, software and such">
  

  
  <!-- end of Twitter cards -->

  <!-- Google Fonts loaded here depending on setting in _data/options.yml true loads font, blank does not-->
  
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
  
  <!-- Load up MathJax script if needed ... specify in /_data/options.yml file-->
  
      <script type="text/x-mathjax-config"> 
        MathJax.Ajax.config.path["Contrib"]="https://cdn.mathjax.org/mathjax/contrib"; 
        MathJax.Hub.Register.StartupHook("TeX Jax Ready",function (){MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{cancel: ["Extension","cancel"], bcancel: ["Extension","cancel"], xcancel: ["Extension","cancel"], cancelto: ["Extension","cancel"]});}); 
        MathJax.Hub.Config({tex2jax:{inlineMath: [['$','$'], ['\\(','\\)']], processEscapes: true}, TeX:{equationNumbers:{autoNumber: "AMS"}, extensions: ["[Contrib]/physics/physics.js","[Contrib]/siunitx/siunitx.js"]}});
      </script>
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  

  <link rel="stylesheet" type="text/css" href="/css/tufte.css">
  <!-- <link rel="stylesheet" type="text/css" href="/css/print.css" media="print"> -->

  <link rel="canonical" href="https://johnhearn.github.io//articles/notes-on-art-of-tdd-uno-part-2">

  <link rel="alternate" type="application/rss+xml" title="John Hearn" href="https://johnhearn.github.io//feed.xml" />
</head>

  <body>
    <!--- Header and nav template site-wide -->
<header>
  <nav class="group">
	  <a href="/">BLOG</a>
	  <a href="/notes.html">NOTES</a>
	  <a href="/about">ABOUT</a>
	</nav>
</header>
    <article class="group">
      <h1>Notes on the Art of TDD - Uno (Part 2)</h1>
<div class="subtitle">May 23, 2017</div>
<div class="smaller">23 minutes.</div>

<p>[Next day - this continues from a <a href="notes-on-art-of-tdd-uno-part-1.html">previous post</a>]</p>

<p>OK. Having mulled over the problem from yesterday I have realised that there are other weaknesses in the current tests. For example I could change the number of cards dealt to each player to 5 and the tests would still pass (and they did). Dealing exactly 7 cards was a requirement of the original test case and we didn’t test for it. I guess that’s teaching us something. Test ALL requirements not just the validity of the final result. Let’s go back a step and start testing the requirements more carefully. I removed the code written in the last step yesterday and wrote a new test for the <code class="language-plaintext highlighter-rouge">deal()</code> method.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDeal</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">UnoGame</span> <span class="n">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnoGame</span><span class="o">(</span><span class="no">PLAYERS</span><span class="o">);</span>
  <span class="kt">int</span> <span class="n">cards</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="na">getPack</span><span class="o">().</span><span class="na">numCards</span><span class="o">();</span>
  <span class="n">game</span><span class="o">.</span><span class="na">deal</span><span class="o">();</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">Player</span> <span class="n">player</span> <span class="o">:</span> <span class="n">game</span><span class="o">.</span><span class="na">players</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">player</span><span class="o">.</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">7</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">getPile</span><span class="o">().</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">getPack</span><span class="o">().</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">cards</span> <span class="o">-</span> <span class="mi">7</span><span class="o">*</span><span class="no">PLAYERS</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">countTotalCards</span><span class="o">(</span><span class="n">game</span><span class="o">)).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">cards</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>That does not compile because <code class="language-plaintext highlighter-rouge">deal()</code> is private (remember we made that decision early on). I’m going to make it protected. That change makes the test run with no more code added. If I change it to deal only 5 cards each, the test fails. Correct. Thats improved the tests at the cost of broadening the protected interface of the game. That seems to be a direct negative consequence of the TDD method but maybe I’m doing it wrong or maybe it’s a price worth paying?</p>

<p>Now commit those changes and move on to add unit tests more systematically following the requirements we lay out.</p>

<blockquote>
  <p>Given [a card], the player plays a card if they match the top card either by the number or color</p>
</blockquote>

<p>Right, let’s write a test which fails for the case mentioned above. We can set up a player with a particular hand and a top card to play on. The <code class="language-plaintext highlighter-rouge">play()</code> method already exists but at the moment always plays any card. The [negative] logic is that is they have no matching card then they have to pass. We can represent a pass as returning null.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPlayerPlaysValidCard</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Player</span> <span class="n">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Player</span><span class="o">();</span>
  <span class="n">player</span><span class="o">.</span><span class="na">giveCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">RED</span><span class="o">));</span>
  <span class="n">player</span><span class="o">.</span><span class="na">giveCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">GREEN</span><span class="o">));</span>

  <span class="nc">Card</span> <span class="n">topCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">);</span>

  <span class="nc">Card</span> <span class="n">playCard</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">playCard</span><span class="o">(</span><span class="n">topCard</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">playCard</span><span class="o">).</span><span class="na">isNull</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Great that will fail but it’s too easy to fix: just return null always, it’s nonsensical. We need to test the positive logic too.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPlayerPlaysPlayableCard</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Player</span> <span class="n">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Player</span><span class="o">();</span>
  <span class="n">player</span><span class="o">.</span><span class="na">giveCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">RED</span><span class="o">));</span>
  <span class="n">player</span><span class="o">.</span><span class="na">giveCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">GREEN</span><span class="o">));</span>

  <span class="nc">Card</span> <span class="n">topCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">);</span>

  <span class="nc">Card</span><span class="err"> </span><span class="n">playCard</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">playCard</span><span class="o">(</span><span class="n">topCard</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">playCard</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">GREEN</span><span class="o">));</span>

  <span class="n">playCard</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">playCard</span><span class="o">(</span><span class="n">topCard</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">playCard</span><span class="o">).</span><span class="na">isNull</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>That’ll be harder to fix and will give a useful result. My only doubt is whether it should be 2 separate tests. Let’s leave it for now and make it pass. This is to code I added.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Card</span> <span class="nf">playCard</span><span class="o">(</span><span class="nc">Card</span> <span class="n">topCard</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Iterator</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">cards</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
  <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">Card</span> <span class="n">next</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">canBePlayedOn</span><span class="o">(</span><span class="n">topCard</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">iter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
      <span class="k">return</span> <span class="n">next</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This code fixes the test but I’ve just realised that we don’t have a test for the final state, namely one less card once it’s been played. Add a new assertion for that particular case.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPlayerPlaysPlayable</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Player</span> <span class="n">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Player</span><span class="o">();</span>
  <span class="n">player</span><span class="o">.</span><span class="na">giveCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">RED</span><span class="o">));</span>
  <span class="n">player</span><span class="o">.</span><span class="na">giveCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">GREEN</span><span class="o">));</span>

  <span class="nc">Card</span> <span class="n">topCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">);</span>

  <span class="nc">Card</span> <span class="n">playCard</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">playCard</span><span class="o">(</span><span class="n">topCard</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">playCard</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">GREEN</span><span class="o">));</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">player</span><span class="o">.</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

  <span class="n">playCard</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">playCard</span><span class="o">(</span><span class="n">topCard</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">playCard</span><span class="o">).</span><span class="na">isNull</span><span class="o">();</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">player</span><span class="o">.</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>That’s getting long so I refactor into 2 tests. I also refactor the tests into another test class and generate the common test data in a <code class="language-plaintext highlighter-rouge">@Before</code> method. That’s much cleaner. Yes, we can refactor tests too!</p>

<p>Now we have another problem. We’ve broken the game!! Now that players return null to pass we are adding null values to the pile. We add a null check but now we have a more serious problem in that if everyone passes then the game never ends. At the same time I’m realising that the original test case is really becoming an integration test. There should be unit tests covering each piece of new logic. This latest problem needs to be tested by inducing a stalemate. We can’t do that while all the internal dependencies are encapsulated in the UnoGame. I’m going to write a new test that creates a suitable test case.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testStalemate</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Player</span> <span class="n">passingPlayer</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">Player</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">when</span><span class="o">(</span><span class="n">passingPlayer</span><span class="o">.</span><span class="na">playCard</span><span class="o">(</span><span class="n">any</span><span class="o">())).</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

  <span class="nc">UnoGame</span> <span class="n">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnoGame</span><span class="o">(</span><span class="n">passingPlayer</span><span class="o">,</span> <span class="n">passingPlayer</span><span class="o">);</span>
  <span class="nc">Player</span> <span class="n">winner</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="na">play</span><span class="o">();</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">winner</span><span class="o">).</span><span class="na">isNull</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>I’ve used <em>Mockito</em> mostly by habit. An alternative way of doing this is by overriding the <code class="language-plaintext highlighter-rouge">Player</code> class itself. Maybe it’ll be simpler.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PassingPlayer</span> <span class="kd">extends</span> <span class="nc">Player</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Card</span> <span class="nf">playCard</span><span class="o">(</span><span class="nc">Card</span> <span class="n">topCard</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testStalemate</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">UnoGame</span> <span class="n">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnoGame</span><span class="o">(</span><span class="k">new</span> <span class="nc">PassingPlayer</span><span class="o">());</span>
  <span class="nc">Player</span> <span class="n">winner</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="na">play</span><span class="o">();</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">winner</span><span class="o">).</span><span class="na">isNull</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Much better. The major change here is that we need to be able to pass player instances to the game. This is actually something required later to set up a game with different player strategies, a good sign. A stalemate is signaled by a null winner.</p>

<p>This test does indeed get us into an infinite loop. We fix it by ensuring that if a whole round is passed then the game ends. I’ve done that with a do-while loop and a pass counter. Green bar again!</p>

<p><label for="wrong-logic" class="margin-toggle"> ⊕</label><input type="checkbox" id="wrong-logic" class="margin-toggle" /><span class="marginnote">This logic is actually wrong. A stalemate happens when the pack no longer has any cards. That was a problem with my knowledge of the game, not of the method, although TDD can sometimes take your eye off that kind thing. One of the reasons TDD is often associated with pair programming. </span></p>

<p>So on the the next test. We’re starting to get into the real game now.</p>

<blockquote>
  <p>…the player plays a card if they [can] <strong><em>otherwise they pick up a card from the pack</em></strong>.</p>
</blockquote>

<p>First write a test for that.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPickupOnPass</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">UnoGame</span> <span class="n">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnoGame</span><span class="o">();</span>
  <span class="kt">int</span> <span class="n">cardsInPack</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="na">getPack</span><span class="o">().</span><span class="na">numCards</span><span class="o">();</span>
  <span class="n">game</span><span class="o">.</span><span class="na">nextTurn</span><span class="o">(</span><span class="k">new</span> <span class="nc">PassingPlayer</span><span class="o">());</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">getPack</span><span class="o">().</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">cardsInPack</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>To write the test I need to be able to isolate a single player’s turn so I’ve introduced the <code class="language-plaintext highlighter-rouge">nextTurn()</code> method which will be protected like <code class="language-plaintext highlighter-rouge">deal()</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">nextTurn</span><span class="o">(</span><span class="nc">Player</span> <span class="n">player</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Card</span> <span class="n">card</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">playCard</span><span class="o">(</span><span class="n">pile</span><span class="o">.</span><span class="na">topCard</span><span class="o">());</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">card</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">pile</span><span class="o">.</span><span class="na">addCard</span><span class="o">(</span><span class="n">card</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">pack</span><span class="o">.</span><span class="na">takeCard</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">card</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">play()</code> method also changes slightly to accommodate the refactoring of the <code class="language-plaintext highlighter-rouge">nextTurn()</code> method. That works but the “acceptance” test now fails. What happened? We actually broke the logic with the last change the test and didn’t realise because the test was not complete. Picking up a card means also adding it to the players hand.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPickupOnPass</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">UnoGame</span> <span class="n">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnoGame</span><span class="o">();</span>
  <span class="n">game</span><span class="o">.</span><span class="na">deal</span><span class="o">();</span>
  <span class="kt">int</span> <span class="n">cardsInPack</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="na">getPack</span><span class="o">().</span><span class="na">numCards</span><span class="o">();</span>
  <span class="nc">PassingPlayer</span> <span class="n">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PassingPlayer</span><span class="o">();</span>
  <span class="n">game</span><span class="o">.</span><span class="na">nextTurn</span><span class="o">(</span><span class="n">player</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">getPack</span><span class="o">().</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">cardsInPack</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">player</span><span class="o">.</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>      <span class="c1">// Card should be added to player's hand</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This test is a little unwieldy. Can we get rid of the call to the <code class="language-plaintext highlighter-rouge">deal()</code> method. It’s only needed to set up the first card in the pile. We can extract the context provided by <code class="language-plaintext highlighter-rouge">deal()</code> and set up the pile as we wish.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPickupOnPass</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Pack</span> <span class="n">pack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Pack</span><span class="o">();</span>
  <span class="nc">Pile</span> <span class="n">pile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Pile</span><span class="o">();</span>
  <span class="n">pile</span><span class="o">.</span><span class="na">addCard</span><span class="o">(</span><span class="n">pack</span><span class="o">.</span><span class="na">takeCard</span><span class="o">());</span>
  <span class="nc">PassingPlayer</span> <span class="n">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PassingPlayer</span><span class="o">();</span>
  <span class="nc">UnoGame</span> <span class="n">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnoGame</span><span class="o">(</span><span class="n">pack</span><span class="o">,</span> <span class="n">pile</span><span class="o">,</span> <span class="n">player</span><span class="o">);</span>
  <span class="n">game</span><span class="o">.</span><span class="na">nextTurn</span><span class="o">(</span><span class="n">player</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">pack</span><span class="o">.</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">34</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">pile</span><span class="o">.</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">player</span><span class="o">.</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This test detects the problem. It also bypasses ugly <code class="language-plaintext highlighter-rouge">game.getPack()</code> accessor. I fix the code.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">nextTurn</span><span class="o">(</span><span class="nc">Player</span> <span class="n">player</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Card</span> <span class="n">card</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="na">playCard</span><span class="o">(</span><span class="n">pile</span><span class="o">.</span><span class="na">topCard</span><span class="o">());</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">card</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">pile</span><span class="o">.</span><span class="na">addCard</span><span class="o">(</span><span class="n">card</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">player</span><span class="o">.</span><span class="na">giveCard</span><span class="o">(</span><span class="n">pack</span><span class="o">.</span><span class="na">takeCard</span><span class="o">());</span>   <span class="c1">// Card is added to player's hand</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">card</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This is now a more general mechanism for testing the game logic which is the problem facing us earlier. I suspect that extracting context objects (aka dependencies) will become a general principle to solve these situations. Commit and onto next test. </p>

<blockquote>
  <p>You can also play a Wild card</p>
</blockquote>

<p>A wild card can be played on any top card and the new colour must be stated. The logic about what card can be played is in the Card class. We can create a new type of Card, WildCard, which supplies the required behaviour.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWildCardLogic</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">WildCard</span> <span class="n">wildcard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WildCard</span><span class="o">();</span>
  <span class="nc">Pack</span> <span class="n">pack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Pack</span><span class="o">();</span>
  <span class="k">while</span> <span class="o">(</span><span class="n">pack</span><span class="o">.</span><span class="na">numCards</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">assertThat</span><span class="o">(</span><span class="n">wildcard</span><span class="o">.</span><span class="na">canBePlayedOn</span><span class="o">(</span><span class="n">pack</span><span class="o">.</span><span class="na">takeCard</span><span class="o">())).</span><span class="na">isTrue</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Easy to implement. Now add some more logic. When playing a wild card the player needs to select a colour. This logic then needs to go into the Player class (the player selects the colour, not the card or the game).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSetColourWhenPlayingWildCard</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Player</span> <span class="n">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Player</span><span class="o">();</span>
  <span class="n">player</span><span class="o">.</span><span class="na">giveCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">WildCard</span><span class="o">());</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">player</span><span class="o">.</span><span class="na">playCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">)).</span><span class="na">colour</span><span class="o">).</span><span class="na">isNotNull</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The player logic is getting a bit nasty but that’s OK because the player logic will be entirely replaced with better algorithms later on. For now we just want to define the contract of the player, which we have done. We’ll update the Pack class to include these new types of cards. The game play will be more varied but the tests have not changed. The tests in general are proving quite resilient. Commit and carry on…</p>

<blockquote>
  <p>Reverse – If going clockwise, switch to counterclockwise or vice versa.</p>
</blockquote>

<p>Since we’re going to be dealing with multiple new card tests I first extract them to a new test class and commit. The tests for this new card are similar to the wild card. <code class="language-plaintext highlighter-rouge">CardTest#testReverseCardLogic()</code> and incrementing the number of cards in the pack. The interesting case is changing direction. Until now all play has been in player order. I go with the same approach as before and extract that piece of logic to a new protected method. The same caveats apply as before. Now we have a new test for that new method, <code class="language-plaintext highlighter-rouge">game#nextPlayer()</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNextPlayerLogic</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">UnoGame</span> <span class="n">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnoGame</span><span class="o">(</span><span class="k">new</span> <span class="nc">Player</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">Player</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">Player</span><span class="o">());</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">nextPlayer</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">))).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">nextPlayer</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">))).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">nextPlayer</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">))).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We refactor and rerun the tests. All green. </p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">int</span> <span class="nf">nextPlayer</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Card</span> <span class="n">topCard</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="n">players</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now it should be straightforward to handle reversing. The test case is:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNextPlayerReverseLogic</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">UnoGame</span> <span class="n">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UnoGame</span><span class="o">(</span><span class="k">new</span> <span class="nc">Player</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">Player</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">Player</span><span class="o">());</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">nextPlayer</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ReverseCard</span><span class="o">(</span><span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">))).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">nextPlayer</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">))).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">nextPlayer</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ReverseCard</span><span class="o">(</span><span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">))).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">nextPlayer</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">))).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>That fails, of course so we can implement it in the new method.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">boolean</span> <span class="n">forwards</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">nextPlayer</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Card</span> <span class="n">topCard</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">topCard</span> <span class="k">instanceof</span> <span class="nc">ReverseCard</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">forwards</span> <span class="o">=</span> <span class="o">!</span><span class="n">forwards</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(!</span><span class="n">forwards</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">players</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="n">players</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="n">players</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>I had a problem with this. The card passed to <code class="language-plaintext highlighter-rouge">nextPlayer()</code> method should be the card played by the last player, not the top card on the pile because a reverse and then a pass should NOT be another reverse. Not sure how to test that case, short of setting up a mini-game and checking the result. Another observation from the last change: a suspicious “<em>instanceof</em>”, very often a sign of poor OO, often meaning that the behaviour should really be in the referenced object. That actually makes sense here. Let’s move the logic into the Card hierarchy. We give the <code class="language-plaintext highlighter-rouge">Card</code> class a <code class="language-plaintext highlighter-rouge">nextStep()</code> function.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCardStep</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Card</span> <span class="n">reverseCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">reverseCard</span><span class="o">.</span><span class="na">nextStep</span><span class="o">(+</span><span class="mi">1</span><span class="o">)).</span><span class="na">isEqualTo</span><span class="o">(+</span><span class="mi">1</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">reverseCard</span><span class="o">.</span><span class="na">nextStep</span><span class="o">(-</span><span class="mi">1</span><span class="o">)).</span><span class="na">isEqualTo</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReverseCardStep</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">ReverseCard</span> <span class="n">reverseCard</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReverseCard</span><span class="o">(</span><span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">reverseCard</span><span class="o">.</span><span class="na">nextStep</span><span class="o">(+</span><span class="mi">1</span><span class="o">)).</span><span class="na">isEqualTo</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">reverseCard</span><span class="o">.</span><span class="na">nextStep</span><span class="o">(-</span><span class="mi">1</span><span class="o">)).</span><span class="na">isEqualTo</span><span class="o">(+</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The existing tests for the <code class="language-plaintext highlighter-rouge">nextPlayer()</code> method complement these tests, testing the associated logic here:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">int</span> <span class="nf">nextPlayer</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Card</span> <span class="n">lastCardPlayed</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">lastCardPlayed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">lastCardPlayed</span><span class="o">.</span><span class="na">nextStep</span><span class="o">(</span><span class="n">step</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">players</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">step</span><span class="o">)</span> <span class="o">%</span> <span class="n">players</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Note that those tests didn’t change at all.</p>

<blockquote>
  <p>Skip – When a player places this card, the next player has to skip their turn.</p>
</blockquote>

<p>Tis should now be easy to implement. The tests are almost identical to the ReverseCard tests with a few minor differences which wash out directly from the tests. The <code class="language-plaintext highlighter-rouge">nextPlayer()</code> function now looks like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">int</span> <span class="nf">nextPlayer</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Card</span> <span class="n">lastCardPlayed</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">step</span> <span class="o">=</span> <span class="o">(</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="o">+</span><span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">lastCardPlayed</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">lastCardPlayed</span><span class="o">.</span><span class="na">nextStep</span><span class="o">(</span><span class="n">step</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">players</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">step</span><span class="o">)</span> <span class="o">%</span> <span class="n">players</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>I see some immediate improvements to be made to make this more flexible but I’ll wait for the need to arise. Patience.</p>

<p>Now I’ve been thinking for a while that I should add validation to the Pile class; we can’t rely on players to abide by the rules! It’s easy to state and test.</p>

<blockquote>
  <p>An invalid card cannot be placed on the pile.</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span><span class="o">=</span><span class="nc">RuntimeException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPileDoesNotAcceptInvalidCard</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Pile</span> <span class="n">pile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Pile</span><span class="o">();</span>
  <span class="n">pile</span><span class="o">.</span><span class="na">addCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">GREEN</span><span class="o">));</span>
  <span class="n">pile</span><span class="o">.</span><span class="na">addCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">GREEN</span><span class="o">));</span>
  <span class="n">pile</span><span class="o">.</span><span class="na">addCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>At this point I did a major refactor of the tests. I was able to simplify them substantially by using separate test classes for different units and setting up standard test data for each class. Then I was able to remove the ugly getters from the game class by accessing the dependent classes directly through the test setup. Well worth the time and the tests give me some confidence that everything is still as it should be.</p>

<p>Next test.</p>

<blockquote>
  <p>Draw Two – When a person places this card, the next player will have to pick up two cards and forfeit his/her turn.</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNextPlayerDrawTwoLogic</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">nextPlayer</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DrawTwoCard</span><span class="o">(</span><span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">))).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">players</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>A test that would have been tricky to write before the refactor is now just 2 easy lines! The setting up of test data and classes is in the common <code class="language-plaintext highlighter-rouge">@Before</code> method.</p>

<p>The test, of course, fails. The first assertion is easy to fix, it’s basically the same as the skip card case. The second is harder and I can’t find an elegant solution with the code and it stands. Which class has the responsibility of drawing the two cards? Certainly not the card in this case, maybe the game itself? Or maybe the <code class="language-plaintext highlighter-rouge">Player</code> should do that. In the end I decided that it should be the game and the test was split into two:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNextPlayerDrawTwoLogic</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">nextPlayer</span><span class="o">(</span><span class="k">new</span> <span class="nc">DrawTwoCard</span><span class="o">(</span><span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">))).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNextTurnDrawTwoLogic</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">pile</span><span class="o">.</span><span class="na">addCard</span><span class="o">(</span><span class="k">new</span> <span class="nc">Card</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">));</span>
  <span class="nc">Player</span> <span class="n">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockPlayer</span><span class="o">(</span><span class="k">new</span> <span class="nc">DrawTwoCard</span><span class="o">(</span><span class="nc">Colour</span><span class="o">.</span><span class="na">BLUE</span><span class="o">));</span>
  <span class="n">game</span><span class="o">.</span><span class="na">nextTurn</span><span class="o">(</span><span class="n">player</span><span class="o">);</span>
  <span class="n">assertThat</span><span class="o">(</span><span class="n">players</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">numCards</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>More tests.</p>

<blockquote>
  <p>Wild Draw Four – This acts just like the wild card except that the next player also has to draw four cards as well as forfeit his/her turn.</p>
</blockquote>

<p>Very similar tests to WildCard and DrawTwoCard and very similar implementation.</p>

<p>One last thing for today. I’ve noticed that sometimes the pack runs out before anyone wins. Also someone could run out of cards while drawing from the pile. The official rules say:</p>

<blockquote>
  <p>At any time, if the pack becomes depleted and no one has yet won the round, take the discard pile, shuffle it, and turn it over to regenerate a new pack.</p>
</blockquote>

<p>Easy to implement but how to test? <a href="notes-on-art-of-tdd-uno-part-4.html">Tomorrow</a>.</p>


<div id="share-bar">

    <div class="share-buttons">
        Share this:
        <a  href="https://twitter.com/intent/tweet?text=Notes on the Art of TDD - Uno (Part 2)&url=https://johnhearn.github.io//articles/notes-on-art-of-tdd-uno-part-2"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on Twitter" >
            <i class="fa-lg fab fa-twitter share-button"></i>
        </a>
        <a  href="https://www.linkedin.com/shareArticle?mini=true&url=https://johnhearn.github.io//articles/notes-on-art-of-tdd-uno-part-2&title=Notes on the Art of TDD - Uno (Part 2)&summary=&source=John Hearn"
            onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;"
            title="Share on LinkedIn" >
            <i class="fa-lg fab fa-linkedin share-button"></i>
        </a>
        <a  href="mailto:?subject=Notes on the Art of TDD - Uno (Part 2)&amp;body=Check out this site https://johnhearn.github.io//articles/notes-on-art-of-tdd-uno-part-2"
            title="Share via Email" >
            <i class="fa-lg fa fa-envelope-open share-button"></i>
        </a>
    </div>

</div>

    </article>
    <span class="print-footer">Notes on the Art of TDD - Uno (Part 2) - May 23, 2017 - John Hearn</span>
    <footer>
  <hr class="slender">
  <ul class="footer-links">
    <li>
        <a href="https://twitter.com/johnhearnbcn">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
        </a>
    </li>
    <li>
        <a href="https://github.com/johnhearn">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fab fa-github fa-stack-1x fa-inverse"></i>
        </span>
        </a>
    </li>
    <li>
        <a href="https://www.linkedin.com/in/john-hearn-599762b">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
        </span>
        </a>
    </li>
    <li>
        <a href="mailto:hearn.john@gmail.com">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-envelope-open fa-stack-1x fa-inverse"></i>
        </span>
        </a>
    </li>
</ul>

<div class="credits">
<span>&copy; 2025 &nbsp;&nbsp;JOHN HEARN</span></br> <br>
<span>This site created with the <a href="//github.com/clayh53/tufte-jekyll">Tufte theme</a> for <a href="//jekyllrb.com">Jekyll</a>.</span> 
</div>  
</footer>
  </body>
</html>
